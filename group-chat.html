<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Chat</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="main-bg">
    <div id="header-container"></div>
    <div class="container" style="max-width:600px;margin:2em auto;">
        <h2 id="group-title" class="page-title" style="color:var(--primary-color);margin-bottom:1.5em;"></h2>
        <div id="chat-area" class="card" style="background:var(--secondary-color);min-height:350px;max-height:350px;overflow-y:auto;padding:1.5em 1em 1em 1em;border-radius:var(--radius-lg);box-shadow:var(--shadow-md);">
            <div id="chat-messages" style="height:250px;overflow-y:auto;padding:0.5em;"></div>
            <div id="chat-input-bar" style="display:flex;align-items:center;gap:0.5em;background:var(--white);padding:0.7em 1.2em;border-top:1px solid var(--gray-200);border-radius:0 0 var(--radius-lg) var(--radius-lg);">
                <input type="text" id="chat-input" placeholder="Type a message..." style="flex:1;border:none;background:var(--gray-50);padding:0.7em 1em;border-radius:2em;font-size:1em;outline:none;" />
                <input type="file" id="file-input" style="display:none;" accept="image/*,video/*,.pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.txt" />
                <button id="attach-btn" class="icon-btn" title="Attach file"><i class="fa fa-paperclip"></i></button>
                <button id="send-chat" class="icon-btn send-btn"><i class="fa fa-paper-plane"></i></button>
            </div>
        </div>
    </div>
    <div id="footer-container"></div>
    <script>
        fetch('header.html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('header-container').innerHTML = html;
                const temp = document.createElement('div');
                temp.innerHTML = html;
                const scripts = temp.querySelectorAll('script');
                scripts.forEach(oldScript => {
                    const s = document.createElement('script');
                    if (oldScript.src) { s.src = oldScript.src; } else { s.textContent = oldScript.textContent; }
                    document.body.appendChild(s);
                });
                if (typeof Header !== 'undefined') { new Header(); }
            })
            .catch(error => console.error('Error loading header:', error));
        fetch('footer.html')
            .then(r => r.text())
            .then(html => { document.getElementById('footer-container').innerHTML = html; })
            .catch(err => console.error('Error loading footer:', err));
        // Get group index from query string
        function getQueryParam(name) {
            const url = new URL(window.location.href);
            return url.searchParams.get(name);
        }
        const groupIdx = getQueryParam('group');
        let studyGroups = JSON.parse(localStorage.getItem('studyGroups') || '[]');
        const group = studyGroups[groupIdx];
        const username = localStorage.getItem('username') || 'Anonymous';
        const userRole = localStorage.getItem('userRole') || '';
        document.getElementById('group-title').textContent = group ? group.name + ' - Group Chat' : 'Group Chat';
        const chatMessages = document.getElementById('chat-messages');
        const chatInputBar = document.getElementById('chat-input-bar');
        function renderChat() {
            chatMessages.innerHTML = '';
            if (!group.chat) group.chat = [];
            group.chat.forEach(msg => {
                const isMe = msg.user === username;
                const bubble = document.createElement('div');
                bubble.className = 'chat-bubble' + (isMe ? ' me' : '');
                bubble.style.maxWidth = '70%';
                bubble.style.margin = isMe ? '0.3em 0 0.3em auto' : '0.3em auto 0.3em 0';
                bubble.style.background = isMe ? '#dcf8c6' : '#fff';
                bubble.style.color = '#222';
                bubble.style.borderRadius = isMe ? '1em 1em 0 1em' : '1em 1em 1em 0';
                bubble.style.padding = '0.6em 1em';
                bubble.style.boxShadow = '0 1px 2px rgba(0,0,0,0.04)';
                bubble.style.position = 'relative';
                let content = `<span style="font-weight:600;color:#075e54;">${msg.user}</span><br>`;
                if (msg.type === 'file' && msg.fileData && msg.fileName) {
                    if (msg.fileType.startsWith('image/')) {
                        content += `<img src="${msg.fileData}" alt="${msg.fileName}" style="max-width:100%;border-radius:0.5em;margin:0.5em 0;" /><br>`;
                    } else if (msg.fileType.startsWith('video/')) {
                        content += `<video controls style="max-width:100%;border-radius:0.5em;margin:0.5em 0;"><source src="${msg.fileData}" type="${msg.fileType}"></video><br>`;
                    } else {
                        content += `<a href="${msg.fileData}" download="${msg.fileName}" style="color:#075e54;font-weight:500;">${msg.fileName}</a><br>`;
                    }
                } else if (msg.type === 'link' && msg.text) {
                    content += `<a href="${msg.text}" target="_blank" style="color:#075e54;font-weight:500;">${msg.text}</a><br>`;
                } else {
                    content += `${msg.text}<br>`;
                }
                content += `<span style="font-size:0.8em;color:#888;position:absolute;bottom:0.3em;right:1em;">${msg.time || ''}</span>`;
                bubble.innerHTML = content;
                chatMessages.appendChild(bubble);
            });
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        if (group && ((group.joined && group.joined.includes(username)) || userRole === 'admin')) {
            chatInputBar.style.display = 'flex';
            renderChat();
            document.getElementById('send-chat').onclick = function() {
                const chatInput = document.getElementById('chat-input');
                let text = chatInput.value.trim();
                if (text) {
                    // Detect link
                    let isLink = /^https?:\/\//i.test(text);
                    group.chat.push({user: username, text: text, time: new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}), type: isLink ? 'link' : 'text'});
                    studyGroups[groupIdx] = group;
                    localStorage.setItem('studyGroups', JSON.stringify(studyGroups));
                    renderChat();
                    chatInput.value = '';
                }
            };
            document.getElementById('attach-btn').onclick = function() {
                document.getElementById('file-input').click();
            };
            document.getElementById('file-input').onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(ev) {
                    group.chat.push({
                        user: username,
                        time: new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}),
                        type: 'file',
                        fileName: file.name,
                        fileType: file.type,
                        fileData: ev.target.result
                    });
                    studyGroups[groupIdx] = group;
                    localStorage.setItem('studyGroups', JSON.stringify(studyGroups));
                    renderChat();
                };
                reader.readAsDataURL(file);
                e.target.value = '';
            };
        } else {
            chatInputBar.style.display = 'none';
            chatMessages.innerHTML = '<div style="color:#b00;padding:1em;text-align:center;">Only joined members can access the group chat.</div>';
        }
    </script>
</body>
</html>
