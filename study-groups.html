<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus Connect - Study Groups</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="header-container"></div>

    <section class="hero-section">
        <div class="container">
            <div class="hero-content">
                <h1 class="hero-title">Study Groups</h1>
                <p class="hero-subtitle">Connect with peers, collaborate, and excel together.</p>
                <img src="https://images.unsplash.com/photo-1513258496099-48168024aec0?w=800&q=80" alt="Students collaborating" class="hero-img" style="max-width: 420px; width: 100%; border-radius: 1.5rem; margin: 2rem auto 0; display: block; box-shadow: 0 8px 32px rgba(101,85,143,0.10);" loading="lazy">
            </div>
        </div>
    </section>

    <section class="section">
        <div class="container">
            <header>
                <h1>Study Group Finder</h1>
            </header>
            <main>
                <section id="search-section">
                    <h2>Find a Study Group</h2>
                    <input type="text" id="search-input" placeholder="Search by subject, course, or topic..." />
                    <button id="search-button">Search</button>
                    <div id="group-listings">
                        <!-- Study group listings will be dynamically added here -->
                    </div>
                </section>
                <section id="create-group-section">
                    <h2>Create a Study Group</h2>
                    <form id="create-group-form">
                        <input type="text" id="group-name" placeholder="Group Name" required />
                        <input type="text" id="group-subject" placeholder="Subject/Course" required />
                        <input type="text" id="group-availability" placeholder="Availability (e.g. Mon/Wed 5-7pm)" required />
                        <input type="text" id="group-mode" placeholder="Mode (Online/Offline/Hybrid)" required />
                        <input type="text" id="group-goal" placeholder="Group Goal (e.g. Exam prep, project, etc.)" required />
                        <textarea id="group-description" placeholder="Description of the group" required></textarea>
                        <input type="text" id="group-contact" placeholder="Contact Info (e.g., email)" required />
                        <button type="submit">Create Group</button>
                    </form>
                </section>
            </main>
        </div>
    </section>

    <div id="footer-container"></div>

    <script>
        fetch('header.html')
            .then(response => response.text())
            .then(html => {
                const container = document.getElementById('header-container');
                container.innerHTML = html;
                const temp = document.createElement('div');
                temp.innerHTML = html;
                const scripts = temp.querySelectorAll('script');
                scripts.forEach(oldScript => {
                    const s = document.createElement('script');
                    if (oldScript.src) { s.src = oldScript.src; } else { s.textContent = oldScript.textContent; }
                    document.body.appendChild(s);
                });
                if (typeof Header !== 'undefined') { new Header(); }
            })
            .catch(error => console.error('Error loading header:', error));

        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('search-input');
            const searchButton = document.getElementById('search-button');
            const groupListings = document.getElementById('group-listings');
            const createGroupForm = document.getElementById('create-group-form');

            let studyGroups = []; // Array to store study group data

            // Function to display study groups
            function displayGroups(groupsToDisplay) {
                groupListings.innerHTML = '';
                const currentUser = localStorage.getItem('username') || '';
                const currentRole = localStorage.getItem('userRole') || '';
                if (groupsToDisplay.length === 0) {
                    groupListings.innerHTML = '<p>No study groups found.</p>';
                    return;
                }
                groupsToDisplay.forEach((group, idx) => {
                    const groupItem = document.createElement('div');
                    groupItem.classList.add('group-item');
                    let actions = '';
                    if (!group.requests) group.requests = [];
                    if (group.creator === currentUser || currentRole === 'admin') {
                        actions += `<button class="delete-btn" data-idx="${idx}">Delete</button>`;
                    } else if (!group.requests.includes(currentUser)) {
                        actions += `<button class="request-btn" data-idx="${idx}">Request to Join</button>`;
                    } else {
                        actions += `<span class="request-status">Requested</span>`;
                    }
                    actions += `<button class="view-btn" data-idx="${idx}">View Group</button>`;
                    // Add chat button for joined members
                    if (group.joined && group.joined.includes(currentUser)) {
                        actions += ` <button class="chat-btn" data-idx="${idx}">Open Chat</button>`;
                    }
                    groupItem.innerHTML = `
                        <h3>${group.name}</h3>
                        <p><strong>Subject:</strong> ${group.subject}</p>
                        <p><strong>Availability:</strong> ${group.availability || ''}</p>
                        <p><strong>Mode:</strong> ${group.mode || ''}</p>
                        <p><strong>Goal:</strong> ${group.goal || ''}</p>
                        <p>${group.description}</p>
                        <p><strong>Contact:</strong> ${group.contact}</p>
                        <div class="group-actions">${actions}</div>
                        <div class="joined-students" id="joined-${idx}">
                            ${group.joined && group.joined.length > 0 ? `<strong>Joined:</strong> ${group.joined.join(', ')}` : ''}
                        </div>
                    `;
                    groupListings.appendChild(groupItem);
                });
                // Add event listeners for request, view, and delete
                document.querySelectorAll('.request-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const idx = this.getAttribute('data-idx');
                        let username = localStorage.getItem('username') || prompt('Enter your name to request:');
                        if (!username) return;
                        if (!studyGroups[idx].requests) studyGroups[idx].requests = [];
                        if (!studyGroups[idx].requests.includes(username)) {
                            studyGroups[idx].requests.push(username);
                            saveGroups();
                            displayGroups(studyGroups);
                            alert('Request sent to group creator.');
                        }
                    });
                });
                document.querySelectorAll('.view-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const idx = this.getAttribute('data-idx');
                        showGroupModal(studyGroups[idx], idx);
                    });
                });
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const idx = this.getAttribute('data-idx');
                        const group = studyGroups[idx];
                        const currentUser = localStorage.getItem('username') || '';
                        const currentRole = localStorage.getItem('userRole') || '';
                        if ((group.creator && group.creator === currentUser) || currentRole === 'admin') {
                            if (confirm('Are you sure you want to delete this group?')) {
                                studyGroups.splice(idx, 1);
                                saveGroups();
                                displayGroups(studyGroups);
                            }
                        } else {
                            alert('Only the group creator or an admin can delete this group.');
                        }
                    });
                });
                document.querySelectorAll('.chat-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const idx = this.getAttribute('data-idx');
                        window.location.href = `group-chat.html?group=${idx}`;
                    });
                });
            }

            // Save groups to localStorage
            function saveGroups() {
                localStorage.setItem('studyGroups', JSON.stringify(studyGroups));
            }

            // Load groups from localStorage or JSON file
            function loadGroups() {
                const local = localStorage.getItem('studyGroups');
                if (local) {
                    studyGroups = JSON.parse(local);
                    displayGroups(studyGroups);
                } else {
                    fetch('data/study-groups.json')
                        .then(r => r.json())
                        .then(data => {
                            // Add creator as empty for initial data
                            studyGroups = data.map(g => ({...g, creator: ''}));
                            saveGroups();
                            displayGroups(studyGroups);
                        })
                        .catch(() => displayGroups([]));
                }
            }

            // Search functionality
            searchButton.addEventListener('click', () => {
                const searchTerm = searchInput.value.toLowerCase();
                const filteredGroups = studyGroups.filter(group =>
                    group.name.toLowerCase().includes(searchTerm) ||
                    group.subject.toLowerCase().includes(searchTerm) ||
                    group.description.toLowerCase().includes(searchTerm)
                );
                displayGroups(filteredGroups);
            });

            // Create group functionality
            createGroupForm.addEventListener('submit', (event) => {
                event.preventDefault();
                const currentUser = localStorage.getItem('username') || prompt('Enter your name as group creator:');
                if (!currentUser) return alert('You must provide your name to create a group.');
                const newGroup = {
                    name: document.getElementById('group-name').value,
                    subject: document.getElementById('group-subject').value,
                    availability: document.getElementById('group-availability').value,
                    mode: document.getElementById('group-mode').value,
                    goal: document.getElementById('group-goal').value,
                    description: document.getElementById('group-description').value,
                    contact: document.getElementById('group-contact').value,
                    joined: [],
                    creator: currentUser,
                    requests: []
                };
                studyGroups.push(newGroup);
                saveGroups();
                displayGroups(studyGroups);
                createGroupForm.reset();
            });
            
            loadGroups();
        });
    </script>

    <script>
        fetch('footer.html')
            .then(r => r.text())
            .then(html => { document.getElementById('footer-container').innerHTML = html; })
            .catch(err => console.error('Error loading footer:', err));
    </script>
</body>
</html>
